# 新しいデータセットの追加・変更手順 (2025-12-21更新版)

## 1. 概要

本ラベリングツールは、画像アセットを外部のクラウドストレージ（Cloudflare R2）で管理し、アプリケーション（Render）はそこにある画像を参照して動作します。そのため、データセットを追加・変更する際は、ローカルのソースコードだけでなく、クラウドストレージ上のアセットと、それを参照するためのマニフェストファイルを更新する必要があります。

このドキュメントは、現在のアーキテクチャに基づいた、データセットの安全な更新手順を記述するものです。

## 2. アーキテクチャの前提条件

現在のシステムは、以下の主要なコンポーネントとルールに基づいています。

1.  **画像ストレージ (Cloudflare R2):**
    - 全ての画像ファイル（`male/`, `female/`）は、R2バケットにアップロードされています。
    - アプリケーションは、このR2バケットに公開URL経由でアクセスします。

2.  **画像マニフェスト (`image_labeler/manifest.txt`):**
    - リポジトリ内にあるこのテキストファイルが、**唯一の信頼できる情報源 (Single Source of Truth)** として、R2に存在する画像ファイル名をリストアップします。
    - 1行に1ファイル名（例: `male/image_01.jpg`）が記載されます。

3.  **データベース初期化スクリプト (`image_labeler/init_db.py`):**
    - アプリケーションがデプロイされる際、このスクリプトが自動的に実行されます。
    - `manifest.txt` を読み込み、リストされた各ファイル名にR2のベースURLを付加して、`Image`テーブルに画像のURLを登録します。**このスクリプトは毎回データベースを一度クリアしてからデータを投入します。**

---

## 3. 具体的なデータセット変更手順

以下の手順に従うことで、データセットを安全に変更できます。

### ステップ1: 新しい画像ファイルの準備

- 新しいデータセットから使用したい画像を選定します。
- 画像を**`male`**と**`female`**という2つのフォルダに分類・整理します。このフォルダ構造は、後の手順で重要になります。
    ```
    /path/to/local_temp_folder/
    ├── male/
    │   ├── new_img_001.jpg
    │   └── new_img_002.jpg
    └── female/
        ├── new_img_101.jpg
        └── new_img_102.jpg
    ```

### ステップ2: Cloudflare R2への画像アップロード

- `rclone`などのツールを使用し、準備した`male/`と`female/`フォルダ内の画像を、Cloudflare R2のバケットにアップロードします。
- **注意:** もし既存のデータセットを完全に置き換える場合は、R2バケットから古い画像ファイルを削除することを推奨します。データセットを追加する場合は、そのまま新しい画像をアップロードしてください。

### ステップ3: `manifest.txt`の更新

- `image_labeler/manifest.txt`ファイルを開きます。
- このファイルを、**ステップ2でR2にアップロードした画像のファイル名リストと完全に一致するように**編集します。
- ファイル名は、`male/`または`female/`から始まるパス形式で記載してください。
    ```
    male/new_img_001.jpg
    male/new_img_002.jpg
    female/new_img_101.jpg
    female/new_img_102.jpg
    ...
    ```
- **最重要:** このファイルの内容が、デプロイ後のデータベースの状態を決定します。記載漏れや間違いがないように注意深く確認してください。

### ステップ4: アプリケーションの再デプロイ

1.  **変更をコミット:**
    - `image_labeler/manifest.txt`の変更を`git add`し、`git commit`で保存します。
    ```bash
    git add image_labeler/manifest.txt
    git commit -m "feat: Update image dataset manifest"
    ```

2.  **リモートリポジトリにプッシュ:**
    - `git push`を実行して、変更をGitHubに反映させます。

3.  **Renderでの自動デプロイ:**
    - GitHubへのプッシュをトリガーとして、Renderが自動的に新しいバージョンのデプロイを開始します。
    - デプロイのビルドプロセス中に`init_db.py`が実行され、古いデータベースがクリアされ、新しい`manifest.txt`の内容に基づいてデータベースが再構築されます。

4.  **動作確認:**
    - デプロイが完了したら、アプリケーションのURLにアクセスし、新しい画像が正しく表示され、ラベリングできることを確認します。

---

この手順に従うことで、ソースコードを変更することなく、データセットの更新が可能です。最も重要なファイルは`image_labeler/manifest.txt`です。