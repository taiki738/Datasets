# プロジェクト進捗サマリー (2025-12-20)

## 1.1 進捗状況の要約

**着手したタスク:** Flaskベースの画像ラベリングアプリケーションをPaaS（Render）へデプロイする。

今回のセッションでは、ローカルで動作していたアプリケーションを、本番環境で動作させるためのデプロイ作業に集中的に取り組みました。Cloudflare R2への画像アセットの移行から始まり、Render上での環境構築、複数回にわたるデプロイエラーのトラブルシューティングを経て、最終的な課題を特定する段階まで到達しました。

**主要なマイルストーン:**

-   **画像アセットのクラウド移行:** `rclone`を用いて、全画像ファイルをCloudflare R2にアップロードし、公開URL経由でのアクセスを確立した。
-   **アプリケーションのR2対応化:** Flaskアプリケーションをリファクタリングし、ローカルファイルシステムへの依存を完全に排除。R2上のURLから画像を動的に読み込むように修正した。
-   **Render環境の構築:** WebサービスとPostgreSQLデータベースをRender上にセットアップし、環境変数を設定した。
-   **デプロイのトラブルシューティング:**
    -   ビルドコマンドのパス修正、非互換性のある`requirements.txt`のクリーンアップ、Renderのデプロイキャッシュ問題の特定と手動デプロイによる解決など、複数の問題を特定し解決した。
-   **根本原因の特定:** 度重なるデプロイ失敗の根本原因が、データベースのテーブルが作成されていないことであり、その引き金が「`Pre-Deploy Command`がRenderの無料プランでは利用できない」という制約であることを突き止めた。

## 1.2 具体的な実装内容や変更履歴

-   **`image_labeler/app.py`**
    -   ローカルからの画像配信機能（`/images/...`）を削除。
    -   R2のベースURLを環境変数 `R2_BASE_URL` から取得するように設定。
    -   `Image`モデルに`url`カラムを追加。
    -   `manifest.txt`を読み込み、R2の画像URLを生成してデータベースを初期化するロジック `_populate_images_from_manifest` を実装。
-   **`image_labeler/templates/index.html`**
    -   フロントエンドのJavaScriptを修正し、APIから受け取った`image.url`を直接`<img>`タグの`src`に設定するように変更。
-   **`image_labeler/init_db.py` （新規作成）**
    -   データベースのテーブル作成（`db.create_all()`）と、画像データの移入（`_populate_images_from_manifest()`）を行う初期化スクリプトを分離・作成した。
-   **`requirements.txt`**
    -   Conda環境固有のローカルパスが含まれ、移植性のない状態だったファイルを完全に上書き。`Flask`, `gunicorn`, `psycopg2-binary`など、プロジェクトに必須のパッケージのみを記載したクリーンな状態に修正した。
-   **`.githubリポジトリ`**
    -   上記すべての変更をコミットし、リモートリポジトリにプッシュした。

## 2. 得られた知見

-   **Render無料プランの制約:**
    -   **知見:** `Pre-Deploy Command`は有料プラン限定の機能である。データベースのマイグレーションや初期化など、デプロイ前の準備ステップが必要なアプリケーションでは、無料プランは大きな制約となる。
    -   **今後の活用:** Renderで新規プロジェクトを計画する際、初期化処理の有無を基準に、最初から有料プランを検討するか、あるいは初期化が不要な設計にするかの判断材料とする。
-   **Renderのデプロイキャッシュ問題:**
    -   **知見:** Gitリポジトリに新しいコードをプッシュしても、Renderが古いコミットを参照し続ける場合がある。
    -   **今後の活用:** デプロイエラーが発生し、コードに問題がないと確信できる場合は、まず「Manual Deploy」を試す。これにより、キャッシュ問題かコードの問題かを迅速に切り分けることができる。
-   **`requirements.txt`の移植性:**
    -   **知見:** `pip freeze`は、環境によってはローカルファイルパスを含む非移植性の高い`requirements.txt`を生成する。
    -   **今後の活用:** CI/CD環境でビルドする場合、`requirements.txt`は手動で管理するか、`pip-tools`のようなツールを用いて依存関係を明示的に管理し、移植性を確保する。
-   **本番環境でのDB初期化:**
    -   **知見:** `if __name__ == '__main__':` 内のコードはGunicornのような本番WSGIサーバーでは実行されない。
    -   **今後の活用:** データベースの初期化やマイグレーションは、FlaskのCLIコマンドとして実装するか、今回試みたようにデプロイフック用の別スクリプトとして用意するのが標準的なアプローチであると再確認した。

## 3. 次のステップの提案

**最優先目標:** データベースの初期化問題を解決し、アプリケーションのデプロイを完了させる。

### **提案A (推奨)**
-   **アクション:** Renderの有料プラン（例: Starterプラン）にアップグレードする。
-   **内容:**
    1.  Webサービスのインスタンスタイプを`Free`から`Starter`等に変更する。
    2.  編集可能になった「Pre-Deploy Command」に`python image_labeler/init_db.py`を設定し、保存する。
    3.  手動でデプロイをトリガーする。
-   **貢献:** これが最も直接的で、本番環境の運用として標準的な解決策となる。今後の機能追加（例: DBスキーマ変更）にも対応しやすくなる。

### **提案B**
-   **アクション:** Render CLIのトラブルシューティングを継続する。
-   **内容:**
    1.  Node.jsのバージョン互換性問題のさらなる調査（LTS版への切り替えなど）。
    2.  `npm cache clean --force`の実行。
    3.  それでも解決しない場合、Renderのサポートへの問い合わせも視野に入れる。
    4.  CLIが動作したら、`render exec`コマンドで`init_db.py`を手動実行する。
-   **貢献:** 無料プランのままデプロイを達成できるが、根本的な解決ではなく、時間と手間がかかるリスクがある。

**最終目標:**
いずれかの方法でデプロイを成功させた後、`https://image-labeler-app.onrender.com` にアクセスし、アンケートの開始から完了まで、全機能が正常に動作することを最終確認する。これにより、プロジェクトの「ラベリングツールのデプロイ」というマイルストーンが完了となる。
