# プロジェクト進捗レポート

## 日時

- 2025-12-16 19:12

## 1.1 進捗状況の要約

今回のセッションでは、以前に計画した**アンケート形式のラベリングツール開発**に着手しました。特に、アプリケーションのバックエンド基盤の構築に注力しました。

主要なマイルストーンは以下の通りです。

- **開発環境の再構築:** Pythonの仮想環境を、より標準的でクリーンな構成に移行しました。
- **データベース基盤のセットアップ:** 新しいツールの中核となるデータベースのモデル（スキーマ）を定義し、アプリケーションと連携させました。
- **コアAPIの実装:** アンケートセッションの開始と、評価結果の保存という、ツールに必須のバックエンドAPIを実装しました。

## 1.2 具体的な実装内容や変更履歴

- **Python仮想環境の移行:**
    - `image_labeler/venv` にあった古い仮想環境を削除しました。
    - プロジェクトルートに `.venv` という名前で新しい仮想環境を作成し、こちらを今後の標準としました。
    
- **依存関係のクリーンアップ:**
    - Anaconda環境に由来する、移植性のないローカルパスが大量に含まれた `image_labeler/requirements.txt` を破棄しました。
    - プロジェクトに直接必要なライブラリ (`Flask`, `qrcode`, `Flask-SQLAlchemy`) のみを新しい仮想環境にインストールし、クリーンな `requirements.txt` をプロジェクトルートに作成しました。

- **`image_labeler/app.py` の大幅な更新:**
    - **データベース設定:** `Flask-SQLAlchemy` を導入し、SQLiteデータベース (`instance/survey.db`) を使用する設定を追加しました。
    - **モデル定義:** `Participant` (参加者), `Image` (画像), `Label` (評価) の3つのデータベースモデルを定義しました。
    - **DB自動構築・データ投入:**
        - アプリケーション起動時に、定義されたモデルに基づいてデータベースとテーブルを自動作成 (`db.create_all()`) する機能を追加しました。
        - 同時に、ファイルシステム (`UTK-FACE/filtered_dataset/`) から画像情報を読み取り、`Image`テーブルに自動で投入するヘルパー関数 (`_populate_images_from_filesystem`) を実装しました。
    - **新規APIエンドポイントの実装:**
        - `/api/start_survey_session`: 新しい参加者を作成し、ラベリング対象の画像リストを返すAPI。
        - `/api/submit_survey_label`: 参加者からの評価を受け取り、`Label`テーブルに保存するAPI。

## 2. 得られた知見

- **仮想環境の可搬性:**
    - Pythonの仮想環境 (`venv`) は、内部のスクリプトに作成時の絶対パスを保持するため、ディレクトリを単純に移動させることができません。環境の場所を変更する際は、**「削除して再作成」**が基本であることを再確認しました。
    - 仮想環境をプロジェクトルートに `.venv` として配置することは、ソースコードと環境の分離を明確にし、各種ツールとの互換性を高める上でベストプラクティスです。

- **`pip freeze` の注意点と依存関係管理:**
    - `pip freeze` は、現在の環境にインストールされている全パッケージをリストアップしますが、元の環境がCondaなどで複雑に構築されている場合、PyPIからのインストールに使えない、移植性のない `requirements.txt` が生成される可能性があります。
    - **教訓:** プロジェクトの再現性を確保するためには、`pip freeze` の出力に頼るだけでなく、プロジェクトが直接依存する最上位のライブラリ（例: `Flask`）を明示的にリストアップし、そこからクリーンな環境を構築するアプローチが極めて重要です。

## 3. 次のステップの提案

バックエンドの基本的な機能が整ったため、次のステップとして、これらの機能が正しく動作するかをテストし、その後フロントエンドの開発に進むことを提案します。

1.  **バックエンドの動作テスト:**
    - `python image_labeler/app.py` を実行してFlaskサーバーを起動します。
    - `curl` などのツールを使い、`/api/start_survey_session` を叩いて、参加者IDと画像リストが返ってくるか確認します。
    - 同様に `/api/submit_survey_label` を叩いて評価を送信し、`instance/survey.db` ファイルにデータが正しく保存されるか確認します。

2.  **フロントエンドの開発:**
    - `templates/index.html` と関連するJavaScriptを修正し、新しいアンケート形式のUIを構築します。
    - UIは、まず `/api/start_survey_session` を呼び出してセッションを開始します。
    - 画像を一枚ずつ表示し、評価ボタン（例: 1〜5のスコア）を設置します。
    - 評価ボタンが押されたら、`/api/submit_survey_label` を呼び出して結果をサーバーに送信するロジックを実装します。

3.  **旧機能のクリーンアップ:**
    - 新しいUIが完成し、データベースベースのシステムが完全に機能するようになった段階で、不要になった古いAPI (`/api/images`, `/api/label`) を `app.py` から削除します。
