# プロジェクト進捗レポート (2025-12-19_10-44)

## 1.1 進捗状況の要約

今回のセッションでは、アプリケーションを本番環境へデプロイするための準備作業に重点を置きました。

主要なマイルストーンとして、デプロイにおける画像データセットの取り扱いという、実践的かつ重要な課題に対する方針を決定しました。Git リポジトリに画像データを含めず、かつ本番環境でアプリケーションが画像を正常に扱えるようにするため、**外部クラウドストレージ（AWS S3 など）を利用する**という、拡張性の高い本番仕様のアーキテクチャを採用することに合意しました。

この方針に基づき、以下のタスクに着手しました。

- **プラン:** 本番デプロイ準備
- **達成事項:**
  - データベーススキーマの修正と、それに伴う起動時エラーの解決。
  - 本番用 Web サーバー(`gunicorn`)とデータベースドライバ(`psycopg2-binary`)の導入。
  - データベース接続設定を環境変数（`DATABASE_URL`）から読み込むようにアプリケーションを修正し、PaaS 環境への対応を完了。
  - デプロイ戦略（クラウドストレージ利用）について議論し、明確な方針を決定。

## 1.2 具体的な実装内容や変更履歴

- **`image_labeler/app.py`の修正:**

  - **DB スキーマ修正:** `Image`モデルにおいて、`filename`単独のユニーク制約を解除し、`filename`と`gender`の組み合わせに対する複合ユニーク制約（`UniqueConstraint`）を追加しました。これにより、男女で同名のファイルが存在する場合の`IntegrityError`を解決しました。
  - **DB 接続の動的化:** データベース URI を`DATABASE_URL`環境変数から取得するように変更しました。これにより、ローカル環境（SQLite）と本番環境（PostgreSQL）の切り替えが容易になりました。

- **`requirements.txt`の更新:**

  - `pip freeze`を実行し、新たに追加した`gunicorn`と`psycopg2-binary`を依存関係ファイルに反映させました。

- **`.gitignore`に関する議論:**
  - 当初、`FairFace`関連のデータファイルを`.gitignore`に追加する要求がありましたが、デプロイ時に画像が利用できなくなる問題が発覚しました。議論の結果、画像は外部のクラウドストレージで管理する方針となったため、この変更は一旦保留となりました。

## 2. 得られた知見

- **デプロイ戦略と静的アセットの分離:**

  - アプリケーションの実行に必要な画像などのアセットを、Git リポジトリに含めるべきではないという一般的な慣習と、PaaS 環境でそれらのアセットをどう利用可能にするか、という現実的な課題の解決策を学びました。
  - 選択肢（Git LFS, ビルド時ダウンロード, 外部クラウドストレージ）を比較検討した結果、長期的な拡張性と保守性から**外部クラウドストレージが最適解**であると判断しました。これは、データ（アセット）とアプリケーションロジックを疎結合に保つという、モダンな Web 開発における重要な設計原則です。

- **リレーショナルデータモデルの実践的理解:**

  - `label`テーブルに画像の性別情報が含まれていなくても、`image`テーブルと`JOIN`することで情報を取得できる、というリレーショナルデータベースの基本原則を再確認しました。これにより、データの冗長性を排除し、整合性を保つ効率的なデータ設計の重要性を実践的に理解できました。

- **データベーススキーマの整合性の重要性:**
  - `UNIQUE`制約のような一見小さなスキーマ定義が、実際のデータの構造と一致していない場合にアプリケーション全体の障害を引き起こすことを確認しました。データベースのスキーマは、扱うデータの性質を正確に反映するよう設計することが不可欠です。

## 3. 次のステップの提案

今回決定した「クラウドストレージ戦略」を具体的に実行に移すことが、次の最優先事項となります。

- **目標:** 画像アセットを外部クラウドストレージに移行し、アプリケーションを完全にポータブルな状態にする。

- **具体的なアクションアイテム:**

  1.  **【ユーザー様】クラウドストレージのセットアップ:**

      - AWS S3 等のクラウドストレージサービスで、公開バケットを作成します。
      - ローカルの`Data/FairFace/fairface_for_survey/`内の全画像ファイルを、作成したバケットにアップロードします。
      - アップロードしたファイルの一般公開設定を行い、バケットのベース URL を準備します。

  2.  **【Gemini】アプリケーションの修正:**
      - 上記のベース URL を基に、`app.py`の画像配信エンドポイント(`/images/...`)を、ローカルファイルではなくクラウドストレージ上の URL へリダイレクトするように修正します。
      - 本番環境で`Image`テーブルを移入するための新しい仕組み（例：画像ファイル名リストを記載したマニフェストファイルからの読み込み）について議論し、実装します。

- **プロジェクト成功への貢献:**
  - これらのステップを完了することで、アプリケーションはローカルのファイルシステムから完全に独立し、PaaS（Render）上でのスケーラブルなデプロイが可能になります。これは、デプロイ成功に向けた最後の大きなアーキテクチャ上の課題を解決することを意味します。
